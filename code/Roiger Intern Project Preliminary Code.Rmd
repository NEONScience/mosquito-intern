---
title: "Roiger Intern Project Preliminary Code"
author: "Charlotte Roiger"
output:
  html_document: default
  word_document: default
---
###Data Frame Set Up

```{r,message=FALSE,echo=FALSE}
library(tidyverse)
library(mosaic)
library(data.table)
trap = read.csv('N:/Science/FSU/Intern Projects/2107_CharlotteRoiger/mos_trapping_in.csv')
sort = read.csv('N:/Science/FSU/Intern Projects/2107_CharlotteRoiger/mos_sorting_in.csv')
id = read.csv('N:/Science/FSU/Intern Projects/2107_CharlotteRoiger/mos_identification_in.csv')
pathogen = read.csv('N:/Science/FSU/Intern Projects/2107_CharlotteRoiger/mos_pathogenresults_in.csv')
source('~/mosquito-intern/code/get_NEON_location.R')


#Creation of a vector with only the unique PlotIDs
uniquePlotIDs<-unique(trap$plotID)


#Creation of a dataframe with location, lat, and lon using updated function
lat<-c()
lon<-c()
for (i in 1:length(uniquePlotIDs)){
  lat[i]=unlist(get_NEON_location(namedLocation = uniquePlotIDs[i],output = "latlon")[2],use.names = FALSE)
  lon[i]=unlist(get_NEON_location(namedLocation = uniquePlotIDs[i],output = "latlon")[3],use.names = FALSE)
}

uniquePlotIDs<-as.character(uniquePlotIDs)
latlon.df<-data.frame(uniquePlotIDs,lat,lon)


#Removing datapoint with lat lon listed as 1,1
latlon.df[latlon.df==1]<-NA

trap$plotID<-as.character(trap$plotID)

#Merging trap df with lat lon data
trap <- merge(x = latlon.df, y = trap, by.y = "plotID", by.x = "uniquePlotIDs") #merge example

#Filling in more lat lon data
trap$lat2<-ifelse(is.na(trap$lat)==TRUE, trap$pdaDecimalLatitude,trap$lat)
trap$lon2<-ifelse(is.na(trap$lon)==TRUE, trap$pdaDecimalLongitude,trap$lon)

#Extracting Year Information for trap
trap$Year<-substr(trap$collectDate,1,4)

#Creating a dataframe with only the unique plotIDs and lat2 lon2 data for merging
uniquetrap<-trap[!duplicated(trap[,1]),c("uniquePlotIDs","lat2","lon2")]

#Changing plotID from factor to character to prevent errors
id$plotID<-as.character(id$plotID)

#Merging id df with lat2 lon2 data
id <- merge(x = uniquetrap, y = id, by.y = "plotID", by.x = "uniquePlotIDs")

#Extracting year information for id
id$Year<-substr(id$collectDate,1,4)

#Chaning year to be a factor rather than a character
id$Year<-as.factor(id$Year)

#Working on time difference offset variable 

#Checks to see if all obs are on the same day or two different days and nothing else
tally(substr(id$setDate,9,10)==substr(id$collectDate,9,10))
tally(substr(id$setDate,9,10)!=substr(id$collectDate,9,10))

#Variable that contains the time difference between set and collection in hours
id$Timediff<-ifelse(substr(id$setDate,9,10)!=substr(id$collectDate,9,10), 24 - ((as.numeric(substr(id$setDate,15,16))/60)+(as.numeric(substr(id$setDate,12,13)))) + ((as.numeric(substr(id$collectDate,15,16))/60)+(as.numeric(substr(id$collectDate,12,13)))),((as.numeric(substr(id$collectDate[8],15,16))/60)+(as.numeric(substr(id$collectDate[8],12,13)))) - ((as.numeric(substr(id$setDate[8],15,16))/60)+(as.numeric(substr(id$setDate[8],12,13)))))

#Creating subsets based on year for id df
levels(id$Year)

id2012<-id[id$Year==2012,]
id2013<-id[id$Year==2013,]
id2014<-id[id$Year==2014,]
id2015<-id[id$Year==2015,]
id2016<-id[id$Year==2016,]

#Working on writing a function that would automatically subset by year? My issue is in the naming of the dataframe then importing it to the global environment every time I run the function the df gets named "dfname" rather than the desired input

#SubsetYear<-function(df,year){
  #dfname <-readline(prompt = "What is the desired name of your new dataframe: ")
  #dfname<-as.character(dfname)
  #dfname <<-df[df$Year==year,]
 #}
#SubsetYear(id,2012)

```

###Species Richness Dataframes

```{r}
#If I merge dataframes then it automatically removes the null plot ID

#Creation of a dataframe that maps plotIds to number of unique scientific names
specrich <-data.frame(sort(uniquePlotIDs),with(id, tapply(id$scientificName, id$uniquePlotIDs, FUN = function(x)
length(unique(x)))), row.names = NULL)

#Renaming Columns
names(specrich)[1]<-"uniquePlotIDs"
names(specrich)[2]<-"Species.richness"

#Merging to get lat2 lon2 data
specrich <- merge(x = uniquetrap, y = specrich, by.y = "uniquePlotIDs", by.x = "uniquePlotIDs")


#Creation of a 2012 dataframe that maps plotIds to number of unique scientific names
specrich2012<-data.frame(sort(uniquePlotIDs),with(id2012, tapply(id2012$scientificName, id2012$uniquePlotIDs, FUN = function(x)
length(unique(x)))), row.names = NULL)

#Renaming Columns
names(specrich2012)[1]<-"uniquePlotIDs"
names(specrich2012)[2]<-"Species.richness"

#Merging to get lat2 lon2 data
specrich2012 <- merge(x = uniquetrap, y = specrich2012, by.y = "uniquePlotIDs", by.x = "uniquePlotIDs")

#Creation of a 2013 dataframe that maps plotIds to number of unique scientific names
specrich2013<-data.frame(sort(uniquePlotIDs),with(id2013, tapply(id2013$scientificName, id2013$uniquePlotIDs, FUN = function(x)
length(unique(x)))), row.names = NULL)

#Renaming Columns
names(specrich2013)[1]<-"uniquePlotIDs"
names(specrich2013)[2]<-"Species.richness"

#Merging to get lat2 lon2 data
specrich2013 <- merge(x = uniquetrap, y = specrich2013, by.y = "uniquePlotIDs", by.x = "uniquePlotIDs")

#Creation of a 2014 dataframe that maps plotIds to number of unique scientific names
specrich2014<-data.frame(sort(uniquePlotIDs),with(id2014, tapply(id2014$scientificName, id2014$uniquePlotIDs, FUN = function(x)
length(unique(x)))), row.names = NULL)

#Renaming Columns
names(specrich2014)[1]<-"uniquePlotIDs"
names(specrich2014)[2]<-"Species.richness"

#Merging to get lat2 lon2 data
specrich2014 <- merge(x = uniquetrap, y = specrich2014, by.y = "uniquePlotIDs", by.x = "uniquePlotIDs")

#Creation of a 2015 dataframe that maps plotIds to number of unique scientific names
specrich2015<-data.frame(sort(uniquePlotIDs),with(id2015, tapply(id2015$scientificName, id2015$uniquePlotIDs, FUN = function(x)
length(unique(x)))), row.names = NULL)

#Renaming Columns
names(specrich2015)[1]<-"uniquePlotIDs"
names(specrich2015)[2]<-"Species.richness"

#Merging to get lat2 lon2 data
specrich2015 <- merge(x = uniquetrap, y = specrich2015, by.y = "uniquePlotIDs", by.x = "uniquePlotIDs")

#Creation of a 2016 dataframe that maps plotIds to number of unique scientific names
specrich2016<-data.frame(sort(uniquePlotIDs),with(id2016, tapply(id2016$scientificName, id2016$uniquePlotIDs, FUN = function(x)
length(unique(x)))), row.names = NULL)

#Creation of df to account for time offset 2016
id2016s<-id2016[sort(unique(id2016$uniquePlotIDs)),c("uniquePlotIDs", "Timediff")]

#Renaming Columns
names(specrich2016)[1]<-"uniquePlotIDs"
names(specrich2016)[2]<-"Species.richness"

#Merging to get lat2 lon2 data
specrich2016 <- merge(x = id2016s, y = specrich2016, by.y = "uniquePlotIDs", by.x = "uniquePlotIDs")


#Applying Loop Code to the specrich dataframe
#Latitude.sr<-c()
#Longitude.sr<-c()
#for (i in 1:nrow(specrich.df)){
  #j<-grep(specrich.df$plotID[i],latlon.df$uniquePlotIDs)
  #Latitude.sr[i]<-latlon.df$lat[j]
  #Longitude.sr[i]<-latlon.df$lon[j]
#}

#specrich.df<-data.frame(specrich.df, Latitude.sr, Longitude.sr)
```

###Some Data Poking (Exploring)

```{r}
library(scales)
#Over representation of females in ID sample
tally(id$sex)

#Table of proportions of female versus male over time
prop.table(table(id$Year,id$sex),1)

#Instances of Ae. albopictus by year
table(id$Year,id$scientificName=="Aedes albopictus")

#Number of times each species identified in id df
tally(id$scientificName)

#Tracking number of sites where Ae. Albopictus has been identified
albo2014<- id2014[id2014$scientificName=="Aedes albopictus",]
albo2015<- id2015[id2015$scientificName=="Aedes albopictus",]
albo2016<- id2016[id2016$scientificName=="Aedes albopictus",]

length(unique(albo2014$uniquePlotIDs)) #18
length(unique(albo2015$uniquePlotIDs)) #9
length(unique(albo2016$uniquePlotIDs)) #45

#Preliminary findings suggest large amount of fluctuation in number of sites, could be due to sampling procedure or changes in biotic variables at each site

#Sum of Ae. albopictus for each year
sum(albo2014$individualCount) # 64
sum(albo2015$individualCount) # 40
sum(albo2016$individualCount) # 308

#Proportion of Ae. albopictus relative to total number collected by year
sum(albo2014$individualCount)/sum(complete.cases(id2014$individualCount)) #0.00605
sum(albo2015$individualCount)/sum(complete.cases(id2015$individualCount)) #0.04264
sum(albo2016$individualCount)/sum(complete.cases(id2016$individualCount)) #0.01281

#Slight increase in proportion of Ae. Albopictus caught over time relative to total number of mosquitos caught exception of 2016. 

```

###Graphs and Visualizations

```{r}
#Preliminary graph of latitude by species richness overall
ggplot(specrich,aes(lat2, Species.richness))+
  geom_point(aes(colour = Species.richness))+
  ggtitle("Species Richness by Latitude all years")

#Scatterplot with regression fit for 2012 ng
ggplot(mod2012$model,aes(lat2, Species.richness))+
  geom_point(aes(colour = Species.richness))+
  ggtitle("Species Richness by Latitude in 2012")+
  stat_smooth(method = "lm", col = "red")

#Preliminary graph of latitude by species richness for 2013
ggplot(specrich2013,aes(lat2, Species.richness))+
  geom_point(aes(colour = Species.richness))+
  ggtitle("Species Richness by Latitude in 2013")

#Scatterplot with regression fit for 2014 nb
ggplot(mod2014$model,aes(lat2, Species.richness))+
  geom_point(aes(colour = Species.richness))+
  ggtitle("Species Richness by Latitude in 2014")+
  stat_smooth(method = "lm", col = "red")

#Scatterplot with regression fit for 2015 ng 
ggplot(mod2015$model,aes(lat2, Species.richness))+
  geom_point(aes(colour = Species.richness))+
  ggtitle("Species Richness by Latitude in 2015")+
  stat_smooth(method = "lm", col = "red")

#Scatterplot with regression fit for 2016 g
ggplot(mod2016$model,aes(lat2, Species.richness))+
  geom_point(aes(colour = Species.richness))+
  ggtitle("Species Richness by Latitude in 2016")+
  stat_smooth(method = "lm", col = "red")

#Visualization of proportion of female mosquitos over time
ggplot(id, aes(x = Year, fill = sex)) +
  geom_bar(position = "fill")+
  labs(y = "Proportions")+
  ggtitle("Proportions of Female Mosquitos by Year")

```

###Preliminary Modeling

```{r}
mod2012<-lm(Species.richness~lat2,data=specrich2012) #Sparse
summary(mod2012)

#omitted 2013 model due to lack of viable data to form model

mod2014<-lm(Species.richness~lat2,data=specrich2014)
summary(mod2014)

mod2015<-lm(Species.richness~lat2,data=specrich2015) #Sparse
summary(mod2015)

mod2016<-lm(Species.richness~lat2 + Timediff,data=specrich2016)
summary(mod2016)
anova(lm(Species.richness~lat2, data = specrich2016), mod2016)

#Fitting a model with the time difference offset for the 2016 model significantly improves the model however the problem is that when we usethe offset, we reduce the complexity of the data since the species richness is calculated based on unique plot ids, but time diff is different for each sample.  
```
